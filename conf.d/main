#!/bin/sh -ex

SITE_NAME=tendenci

DB_NAME=$SITE_NAME
DB_USER=$SITE_NAME
DB_PASS=$(mcookie)

SITE_DIR=/var/www/$SITE_NAME
TENDENCI_USERNAME=admin
TENDENCI_PASSWD=admin
USER_EMAIL=root@localhost
SECRET_KEY=`date | md5sum | head -c 16`

# create the tendenci site folder
mkdir -p $SITE_DIR
cd $SITE_DIR

pip install virtualenv
virtualenv venv --distribute
. venv/bin/activate

pip install tendenci

create-tendenci-project

pip install -r requirements/dev.txt

# start postgresql
service postgresql restart

# create tendenci database
psql -U postgres -c "CREATE USER $DB_USER WITH PASSWORD '$DB_PASS';"
psql -U postgres -c "CREATE DATABASE $DB_NAME WITH OWNER $DB_USER;"
psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;"

# update DATABASE_URL in .env
sed -i "s|DATABASE_URL\s*=\(.*\)|DATABASE_URL='postgres://$DB_USER:$DB_PASS@localhost/$DB_NAME'|" .env

# add some variables in .env
echo "LOCAL_MEMCACHED_URL='127.0.0.1:11211'" >> .env
echo "EMAIL_HOST='localhost'" >> .env
echo "EMAIL_PORT='25'" >> .env
echo "HAYSTACK_SEARCH_ENGINE='whoosh'" >> .env
echo "SECRET_KEY='$SECRET_KEY'" >> .env

# run deploy.py
python deploy.py

# create tendenci superuser
cat>>$SITE_DIR/create_superuser.py<<EOF
import os
os.environ['DJANGO_SETTINGS_MODULE'] = 'conf.settings'
import conf.settings
from django.contrib.auth.models import User
User.objects.create_superuser('$TENDENCI_USERNAME', '$USER_EMAIL', '$TENDENCI_PASSWD')
EOF
python $SITE_DIR/create_superuser.py
rm $SITE_DIR/create_superuser.py

# install default data
python manage.py load_npo_defaults

# update index
python manage.py update_index

# create tendenci user and group - to be used by gunicorn
useradd tendenci -d /nonexistent
groupadd -f tendenci
usermod -a -G tendenci tendenci

# change owner
chown -R tendenci:www-data $SITE_DIR

# setup gunicorn
if [ ! -d $SITE_DIR/run ]; then
	mkdir $SITE_DIR/run
fi
cp /var/bin/gunicorn_start.sh venv/bin/gunicorn_start
chmod +x venv/bin/gunicorn_start

# supervisor reread conf files and update
service supervisor start
#supervisorctl reread
#supervisorctl update

# supervisor start tendenci
supervisorctl start tendenci

# create a symlink
if [ ! -d /etc/nginx/sites-enabled ]; then
	mkdir /etc/nginx/sites-enabled
fi
ln -s /etc/nginx/sites-available/$SITE_NAME /etc/nginx/sites-enabled/$SITE_NAME

# remove nginx default
if [ -f /etc/nginx/sites-enabled/default ]; then
	rm /etc/nginx/sites-enabled/default
fi

# restart nginx
#service nginx restart

# restart memcachd
#service memcached start

# stop services
#service postgresql stop
#supervisorctl stop tendenci
#service nginx stop
#service supervisor stop
