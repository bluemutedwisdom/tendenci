#!/bin/sh -ex

SITE_NAME=tendenci

DB_NAME=$SITE_NAME
DB_USER=$SITE_NAME
DB_PASS=$(mcookie)

SITE_DIR=/var/www/$SITE_NAME
TENDENCI_USERNAME=admin
TENDENCI_PASSWD=admin
USER_EMAIL=root@localhost
SECRET_KEY=`date | md5sum | head -c 16`

# Debian GNU/Linux 6.0.7 (squeeze) has python2.6 installed,
# but we need python2.7 for tendenci
python_version=`python --version 2>&1 | awk '{print $2}' | cut -c1-3`
if [ "$python_version" == "2.6" ]
then
	# install python2.7
	#wget "http://python.org/ftp/python/2.7.5/Python-2.7.5.tgz"
	cd /var/packages
	tar -xzvf Python-2.7.5.tgz
	cd Python-2.7.5
	./configure
	make
	make install
	
	# install pip
	easy_install pip
fi

# start postgresql
service postgresql restart

# create the tendenci site folder
mkdir -p $SITE_DIR
chown root:www-data $SITE_DIR
cd $SITE_DIR

# make a virtualenv
pip install virtualenv
py_path=`which python`
virtualenv venv --distribute -p $py_path
. venv/bin/activate

# install tendenci
pip install html5lib
pip install python-openid>=2.2
pip install --index-url=file:///var/packages/pypi/simple tendenci
create-tendenci-project
pip install tendenci-videos>=1.0.2
pip install -r requirements/dev.txt --index-url=file:///var/packages/pypi/simple

# create tendenci database
psql -U postgres -c "CREATE USER $DB_USER WITH PASSWORD '$DB_PASS';"
psql -U postgres -c "CREATE DATABASE $DB_NAME WITH OWNER $DB_USER;"
psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;"

# update DATABASE_URL in .env
sed -i "s|DATABASE_URL\s*=\(.*\)|DATABASE_URL='postgres://$DB_USER:$DB_PASS@localhost/$DB_NAME'|" .env

# add some variables in .env
echo "LOCAL_MEMCACHED_URL='127.0.0.1:11211'" >> .env
echo "EMAIL_HOST='localhost'" >> .env
echo "EMAIL_PORT='25'" >> .env
echo "HAYSTACK_SEARCH_ENGINE='whoosh'" >> .env
echo "SECRET_KEY='$SECRET_KEY'" >> .env

# run deploy.py
python deploy.py

# create tendenci superuser
cat>>$SITE_DIR/create_superuser.py<<EOF
import os
os.environ['DJANGO_SETTINGS_MODULE'] = 'conf.settings'
import conf.settings
from django.contrib.auth.models import User
User.objects.create_superuser('$TENDENCI_USERNAME', '$USER_EMAIL', '$TENDENCI_PASSWD')
EOF
python $SITE_DIR/create_superuser.py
rm $SITE_DIR/create_superuser.py

# install default data
python manage.py load_npo_defaults

# start upstart script
service $SITE_NAME start

# create a symlink
ln -s /etc/nginx/sites-available/$SITE_NAME /etc/nginx/sites-enabled/$SITE_NAME

# remove nginx default
rm /etc/nginx/sites-enabled/default

# restart nginx
service nginx restart

# restart memcachd
service memcached start

